<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Art Burger</title>
    <link rel="shortcut icon" type="image/jpg" href="images/logo1.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        header {
            background: #EA1D2C;
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            font-weight: bold;
        }

        header .steps {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        header .step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            opacity: 0.7;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        header .step.active {
            opacity: 1;
            font-weight: bold;
        }

        header .step .number {
            background: rgba(255,255,255,0.3);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        header .step.active .number {
            background: white;
            color: #EA1D2C;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
            }
            header .steps {
                display: none;
            }
        }

        .main-content {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .sidebar {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            height: fit-content;
            position: sticky;
            top: 80px;
        }

        h2 {
            color: #EA1D2C;
            margin-bottom: 20px;
            font-size: 24px;
        }

        h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .product-card {
            border: 2px solid #EA1D2C;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
        }

        .product-card img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }

        .product-info {
            flex: 1;
        }

        .product-info h3 {
            margin-bottom: 5px;
        }

        .product-info p {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .price {
            font-size: 18px;
            font-weight: bold;
            color: #EA1D2C;
        }

        .category-header {
            background: #ddd;
            padding: 10px 15px;
            border-radius: 4px;
            margin-top: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .category-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .item-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .item-option:hover {
            background: #f9f9f9;
        }

        .item-option label {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            cursor: pointer;
        }

        .item-option input[type="checkbox"],
        .item-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            padding: 4px 8px;
        }

        .quantity-control button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #EA1D2C;
            padding: 0 4px;
            transition: transform 0.2s;
        }

        .quantity-control button:hover {
            transform: scale(1.2);
        }

        .quantity-control input {
            width: 30px;
            text-align: center;
            border: none;
            background: none;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #EA1D2C;
            box-shadow: 0 0 0 2px rgba(234, 29, 44, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .qr-container {
            text-align: center;
            margin: 20px 0;
        }

        .qr-code {
            display: inline-block;
            padding: 10px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .qr-code img {
            max-width: 256px;
            max-height: 256px;
        }

        .pix-code {
            background: #f9f9f9;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .pix-code input {
            flex: 1;
            border: none;
            background: none;
            font-family: monospace;
            font-size: 12px;
            padding: 0;
        }

        .pix-code button {
            background: #EA1D2C;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            transition: background 0.3s;
        }

        .pix-code button:hover {
            background: #d91a26;
        }

        .sidebar h3 {
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 2px solid #EA1D2C;
            padding-bottom: 10px;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .summary-item.total {
            border-top: 2px solid #ddd;
            padding-top: 10px;
            font-size: 18px;
            font-weight: bold;
            color: #EA1D2C;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #EA1D2C;
            color: white;
        }

        .btn-primary:hover {
            background: #d91a26;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(234, 29, 44, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .alert-error {
            background: #ffebee;
            color: #c62828;
            border-left: 4px solid #c62828;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #EA1D2C;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            text-align: center;
            padding: 40px 20px;
        }

        .success-message i {
            font-size: 60px;
            color: #4caf50;
            margin-bottom: 20px;
        }

        .success-message h2 {
            color: #4caf50;
            margin-bottom: 10px;
        }

        .success-message p {
            color: #666;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-burger"></i>
            Art Burger
        </div>
        <div class="steps">
            <div class="step active" data-step="1">
                <span class="number">1</span>
                <span>Adicionais</span>
            </div>
            <div class="step" data-step="2">
                <span class="number">2</span>
                <span>Entrega</span>
            </div>
            <div class="step" data-step="3">
                <span class="number">3</span>
                <span>Pagamento</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="content">
            <div class="main-content">
                <!-- STEP 1: ADICIONAIS -->
                <div id="step-1" class="step-content active">
                    <h2>Escolha seus Adicionais</h2>
                    
                    <div class="product-card">
                        <img id="productImage" src="images/cover.png" alt="Produto">
                        <div class="product-info">
                            <h3 id="productName">Carregando...</h3>
                            <p id="productDescription">Aguarde...</p>
                            <div class="price">R$ <span id="productPrice">0.00</span></div>
                        </div>
                    </div>

                    <div class="category-header">
                        <span>Adicionais</span>
                        <span id="additionals-count">0/2</span>
                    </div>
                    <div class="category-items" id="additionals-list"></div>

                    <div class="category-header">
                        <span>Refrigerantes (2 LITROS)</span>
                        <span id="drinks-count">0/1</span>
                    </div>
                    <div class="category-items" id="drinks-list"></div>

                    <div class="button-group">
                        <button class="btn-primary" onclick="nextStep()">Continuar</button>
                    </div>
                </div>

                <!-- STEP 2: ENTREGA -->
                <div id="step-2" class="step-content">
                    <h2>Dados de Entrega</h2>

                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" id="customerName" placeholder="Ex: Jo√£o Silva">
                    </div>

                    <div class="form-group">
                        <label>Telefone/WhatsApp *</label>
                        <input type="tel" id="customerPhone" placeholder="(00) 00000-0000">
                    </div>

                    <div class="form-group">
                        <label>E-mail *</label>
                        <input type="email" id="customerEmail" placeholder="seuemail@exemplo.com">
                    </div>

                    <div class="form-group">
                        <label>CPF *</label>
                        <input type="text" id="customerCPF" placeholder="000.000.000-00" maxlength="14">
                    </div>

                    <div class="form-group">
                        <label>CEP *</label>
                        <input type="text" id="customerZipCode" placeholder="00000-000" maxlength="9">
                    </div>

                    <div class="form-group">
                        <label>Rua *</label>
                        <input type="text" id="customerAddress" placeholder="Avenida Paulista">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>N√∫mero *</label>
                            <input type="text" id="customerNumber" placeholder="1000">
                        </div>
                        <div class="form-group">
                            <label>Bairro *</label>
                            <input type="text" id="customerNeighborhood" placeholder="Bela Vista">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Complemento (Opcional)</label>
                        <input type="text" id="customerComplement" placeholder="Apto 101">
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="previousStep()">Voltar</button>
                        <button class="btn-primary" onclick="nextStep()">Ir para Pagamento</button>
                    </div>
                </div>

                <!-- STEP 3: PAGAMENTO -->
                <div id="step-3" class="step-content">
                    <h2>Pagamento via PIX</h2>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <span>Escaneie o QR Code abaixo ou copie o c√≥digo PIX para realizar o pagamento.</span>
                    </div>

                    <div class="qr-container">
                        <div id="qrcode" class="qr-code"></div>
                        <p style="color: #666; font-size: 12px;">Escaneie com seu celular</p>
                    </div>

                    <div class="form-group">
                        <label>C√≥digo Copia e Cola</label>
                        <div class="pix-code">
                            <input type="text" id="pixCode" readonly>
                            <button onclick="copyPixCode()">
                                <i class="fas fa-copy"></i>
                                Copiar
                            </button>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i>
                        <span>Ap√≥s realizar o pagamento, seu pedido ser√° confirmado automaticamente.</span>
                    </div>

                    <div class="button-group">
                        <button class="btn-secondary" onclick="previousStep()">Voltar</button>
                        <button class="btn-primary" onclick="finalizePurchase()">Finalizar Compra</button>
                    </div>
                </div>

                <!-- SUCCESS MESSAGE -->
                <div id="step-success" class="step-content">
                    <div class="success-message">
                        <i class="fas fa-check-circle"></i>
                        <h2>Pedido Confirmado!</h2>
                        <p>Seu pedido foi recebido com sucesso.</p>
                        <p id="successMessage"></p>
                        <button class="btn-primary" onclick="location.href='index.html'" style="margin-top: 20px;">Voltar ao In√≠cio</button>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <h3>Resumo do Pedido</h3>
                <div id="summary"></div>
                <div class="summary-item total">
                    <span>Total:</span>
                    <span>R$ <span id="totalPrice">0.00</span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√µes da API PIX
        const PIX_API_TOKEN = 'b9eb34f2-dafa-41da-97fc-338b2061aa7d';
        const PIX_API_SECRET = '6d4e99b2-4dcd-46f7-864d-094c468b6032';

        // Obter par√¢metros da URL
        const urlParams = new URLSearchParams(window.location.search);
        const productName = urlParams.get('name') || 'Combo Triplo da casa - 3 Burg√µes + Batata Especial 650g + Salgadinhos + 1 Refri 2L';
        const productPrice = parseFloat(urlParams.get('price') || '39.90');
        const productImage = urlParams.get('image') || 'images/cover.png';
        const productDescription = urlParams.get('desc') || '3 hamb√∫rgueres artesanais no p√£o brioche, com carne suculenta, cheddar derretido, bacon crocante e alface fresquinha. Acompanha 1 por√ß√£o especial de batata frita (650g) com muito cheddar, salgadinho e maionese e cubos de bacon frito. E ainda vem refrigerante!';

        // Dados do produto
        const product = {
            id: 1,
            name: productName,
            description: productDescription,
            basePrice: productPrice,
            image: productImage
        };

        // Atualizar informa√ß√µes do produto na p√°gina
        document.getElementById('productName').textContent = product.name;
        document.getElementById('productDescription').textContent = product.description;
        document.getElementById('productPrice').textContent = product.basePrice.toFixed(2);
        document.getElementById('productImage').src = product.image;

        // Adicionais
        const additionals = [
            { id: 1, name: 'Anel de Cebola Amilanesa', price: 0, category: 'additionals' },
            { id: 2, name: 'Queijo Provolone', price: 0, category: 'additionals' },
            { id: 3, name: 'Queijo Cheddar', price: 0, category: 'additionals' },
            { id: 4, name: 'Queijo Americano', price: 0, category: 'additionals' },
            { id: 5, name: 'Catupiry', price: 0, category: 'additionals' },
            { id: 6, name: 'Bacon', price: 0, category: 'additionals' },
        ];

        // Bebidas
        const drinks = [
            { id: 7, name: 'Guaran√° Antartica', price: 0, category: 'drinks' },
            { id: 8, name: 'Fanta Laranja', price: 0, category: 'drinks' },
            { id: 9, name: 'Coca-Cola', price: 0, category: 'drinks' },
            { id: 10, name: 'Guaran√° Antartica Zero', price: 0, category: 'drinks' },
            { id: 11, name: 'Fanta Zero', price: 0, category: 'drinks' },
            { id: 12, name: 'Coca-Cola Zero', price: 0, category: 'drinks' },
        ];

        // Estado do checkout
        let state = {
            currentStep: 1,
            selectedAdditionals: new Map(),
            selectedDrinks: new Map(),
            customerName: '',
            customerPhone: '',
            customerEmail: '',
            customerCPF: '',
            customerZipCode: '',
            customerAddress: '',
            customerNumber: '',
            customerNeighborhood: '',
            customerComplement: '',
            pixCode: '',
            pixQrCode: ''
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            renderAdditionals();
            renderDrinks();
            updateSummary();
            setupStepNavigation();
        });

        function renderAdditionals() {
            const container = document.getElementById('additionals-list');
            container.innerHTML = additionals.map(item => `
                <div class="item-option">
                    <label>
                        <input type="checkbox" value="${item.id}" onchange="toggleAdditional(${item.id})">
                        <span>${item.name}</span>
                    </label>
                    <div class="quantity-control">
                        <button onclick="decrementAdditional(${item.id})">‚àí</button>
                        <input type="text" value="0" readonly id="qty-${item.id}">
                        <button onclick="incrementAdditional(${item.id})">+</button>
                    </div>
                </div>
            `).join('');
        }

        function renderDrinks() {
            const container = document.getElementById('drinks-list');
            container.innerHTML = drinks.map(item => `
                <div class="item-option">
                    <label>
                        <input type="radio" name="drinks" value="${item.id}" onchange="selectDrink(${item.id})">
                        <span>${item.name}</span>
                    </label>
                </div>
            `).join('');
        }

        function toggleAdditional(id) {
            const checkbox = document.querySelector(`input[value="${id}"]`);
            if (checkbox.checked) {
                if (state.selectedAdditionals.size < 2) {
                    state.selectedAdditionals.set(id, 1);
                    document.getElementById(`qty-${id}`).value = '1';
                } else {
                    checkbox.checked = false;
                    Swal.fire('Limite atingido', 'Voc√™ pode selecionar at√© 2 adicionais', 'warning');
                }
            } else {
                state.selectedAdditionals.delete(id);
                document.getElementById(`qty-${id}`).value = '0';
            }
            updateSummary();
        }

        function incrementAdditional(id) {
            if (!state.selectedAdditionals.has(id)) {
                if (state.selectedAdditionals.size < 2) {
                    state.selectedAdditionals.set(id, 1);
                    document.querySelector(`input[value="${id}"]`).checked = true;
                } else {
                    Swal.fire('Limite atingido', 'Voc√™ pode selecionar at√© 2 adicionais', 'warning');
                    return;
                }
            } else {
                state.selectedAdditionals.set(id, state.selectedAdditionals.get(id) + 1);
            }
            document.getElementById(`qty-${id}`).value = state.selectedAdditionals.get(id);
            updateSummary();
        }

        function decrementAdditional(id) {
            if (state.selectedAdditionals.has(id)) {
                const qty = state.selectedAdditionals.get(id) - 1;
                if (qty <= 0) {
                    state.selectedAdditionals.delete(id);
                    document.querySelector(`input[value="${id}"]`).checked = false;
                    document.getElementById(`qty-${id}`).value = '0';
                } else {
                    state.selectedAdditionals.set(id, qty);
                    document.getElementById(`qty-${id}`).value = qty;
                }
            }
            updateSummary();
        }

        function selectDrink(id) {
            state.selectedDrinks.clear();
            state.selectedDrinks.set(id, 1);
            updateSummary();
        }

        function updateSummary() {
            let summary = `<div class="summary-item"><strong>Produto:</strong></div>
                          <div class="summary-item"><span>${product.name.substring(0, 40)}...</span></div>`;

            if (state.selectedAdditionals.size > 0) {
                summary += `<div class="summary-item"><strong>Adicionais:</strong></div>`;
                state.selectedAdditionals.forEach((qty, id) => {
                    const item = additionals.find(a => a.id === id);
                    if (item) {
                        summary += `<div class="summary-item"><span>${item.name} x${qty}</span></div>`;
                    }
                });
            }

            if (state.selectedDrinks.size > 0) {
                state.selectedDrinks.forEach((qty, id) => {
                    const item = drinks.find(d => d.id === id);
                    if (item) {
                        summary += `<div class="summary-item"><span>ü•§ ${item.name}</span></div>`;
                    }
                });
            }

            document.getElementById('summary').innerHTML = summary;
            
            // Atualizar contadores
            document.getElementById('additionals-count').textContent = `${state.selectedAdditionals.size}/2`;
            document.getElementById('drinks-count').textContent = `${state.selectedDrinks.size}/1`;

            // Atualizar total
            let total = product.basePrice;
            state.selectedAdditionals.forEach((qty, id) => {
                const item = additionals.find(a => a.id === id);
                if (item) total += item.price * qty;
            });
            state.selectedDrinks.forEach((qty, id) => {
                const item = drinks.find(d => d.id === id);
                if (item) total += item.price * qty;
            });

            document.getElementById('totalPrice').textContent = total.toFixed(2);
        }

        async function nextStep() {
            if (state.currentStep === 1) {
                if (state.selectedDrinks.size === 0) {
                    Swal.fire('Selecione uma bebida', 'Voc√™ precisa escolher um refrigerante', 'warning');
                    return;
                }
                goToStep(2);
            } else if (state.currentStep === 2) {
                if (!validateDeliveryForm()) {
                    return;
                }
                await generatePixPayment();
            }
        }

        function previousStep() {
            if (state.currentStep > 1) {
                goToStep(state.currentStep - 1);
            }
        }

        function goToStep(step) {
            document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
            document.getElementById(`step-${step}`).classList.add('active');

            document.querySelectorAll('header .step').forEach(el => el.classList.remove('active'));
            document.querySelector(`header .step[data-step="${step}"]`)?.classList.add('active');

            state.currentStep = step;
            window.scrollTo(0, 0);
        }

        function validateDeliveryForm() {
            state.customerName = document.getElementById('customerName').value.trim();
            state.customerPhone = document.getElementById('customerPhone').value.trim();
            state.customerEmail = document.getElementById('customerEmail').value.trim();
            state.customerCPF = document.getElementById('customerCPF').value.trim();
            state.customerZipCode = document.getElementById('customerZipCode').value.trim();
            state.customerAddress = document.getElementById('customerAddress').value.trim();
            state.customerNumber = document.getElementById('customerNumber').value.trim();
            state.customerNeighborhood = document.getElementById('customerNeighborhood').value.trim();
            state.customerComplement = document.getElementById('customerComplement').value.trim();

            if (!state.customerName || !state.customerPhone || !state.customerEmail || !state.customerCPF ||
                !state.customerZipCode || !state.customerAddress || !state.customerNumber || !state.customerNeighborhood) {
                Swal.fire('Campos obrigat√≥rios', 'Preencha todos os campos obrigat√≥rios', 'warning');
                return false;
            }

            // Validar email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(state.customerEmail)) {
                Swal.fire('E-mail inv√°lido', 'Por favor, insira um e-mail v√°lido', 'warning');
                return false;
            }

            // Validar CPF (formato b√°sico)
            const cpfClean = state.customerCPF.replace(/\D/g, '');
            if (cpfClean.length !== 11) {
                Swal.fire('CPF inv√°lido', 'Por favor, insira um CPF v√°lido com 11 d√≠gitos', 'warning');
                return false;
            }

            return true;
        }

        async function generatePixPayment() {
            // Mostrar loading
            Swal.fire({
                title: 'Gerando PIX...',
                text: 'Por favor, aguarde',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            try {
                // Calcular total
                let total = product.basePrice;
                state.selectedAdditionals.forEach((qty, id) => {
                    const item = additionals.find(a => a.id === id);
                    if (item) total += item.price * qty;
                });
                state.selectedDrinks.forEach((qty, id) => {
                    const item = drinks.find(d => d.id === id);
                    if (item) total += item.price * qty;
                });

                // Limpar CPF para enviar apenas n√∫meros
                const cpfClean = state.customerCPF.replace(/\D/g, '');

                // Preparar dados para enviar √† API
                const payload = {
                    token: PIX_API_TOKEN,
                    secret: PIX_API_SECRET,
                    amount: total.toFixed(2),
                    debtor_name: state.customerName,
                    email: state.customerEmail,
                    debtor_document_number: cpfClean,
                    phone: state.customerPhone.replace(/\D/g, ''),
                    method_pay: 'pix'
                };

                console.log('Gerando PIX com dados:', { ...payload, token: '***', secret: '***' });

                // Tentar chamar a fun√ß√£o Netlify primeiro, se falhar, chamar diretamente a API
                let result;
                let usedNetlifyFunction = false;
                
                try {
                    console.log('Tentando Netlify Function...');
                    const response = await fetch('/.netlify/functions/generate-pix', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    result = await response.json();
                    usedNetlifyFunction = true;
                    console.log('‚úì Resposta Netlify Function:', result);
                } catch (netlifyError) {
                    console.log('‚ö† Netlify Function n√£o dispon√≠vel:', netlifyError.message);
                    console.log('‚Üí Chamando API Trex Pay diretamente...');
                    
                    // Fallback: chamar API diretamente
                    const response = await fetch('https://app.trexpay.com.br/api/wallet/deposit/payment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`API Trex Pay retornou erro: ${response.status} - ${errorText}`);
                    }

                    result = await response.json();
                    console.log('‚úì Resposta API Trex Pay:', result);
                    
                    // Normalizar resposta
                    if (result.qrcode) {
                        result.success = true;
                    }
                }

                if (result.success || result.qrcode) {
                    // Armazenar c√≥digo PIX
                    state.pixCode = result.qrcode;
                    state.pixQrCode = result.qr_code_image_url || result.qr_code_data_url;
                    state.idTransaction = result.idTransaction;

                    console.log('‚úì PIX gerado com sucesso!');
                    console.log('  - ID Transa√ß√£o:', result.idTransaction);
                    console.log('  - C√≥digo PIX:', result.qrcode ? result.qrcode.substring(0, 50) + '...' : 'N/A');
                    console.log('  - M√©todo usado:', usedNetlifyFunction ? 'Netlify Function' : 'API Direta');

                    // Exibir c√≥digo PIX
                    document.getElementById('pixCode').value = result.qrcode;

                    // Gerar QR Code
                    const qrContainer = document.getElementById('qrcode');
                    qrContainer.innerHTML = '';
                    
                    // Prioridade: qr_code_data_url (base64) > qr_code_image_url > fallback
                    let qrCodeUrl = result.qr_code_data_url || result.qr_code_image_url;
                    
                    if (!qrCodeUrl && result.qrcode) {
                        // Fallback: usar servi√ßo de QR Code online
                        qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(result.qrcode)}`;
                        console.log('‚Üí Usando QR Code externo como fallback');
                    }
                    
                    if (qrCodeUrl) {
                        const img = document.createElement('img');
                        img.src = qrCodeUrl;
                        img.alt = 'QR Code PIX';
                        img.style.width = '300px';
                        img.style.height = '300px';
                        img.style.border = '2px solid #ddd';
                        img.style.borderRadius = '8px';
                        img.style.padding = '10px';
                        img.style.background = 'white';
                        
                        // Adicionar evento de erro para fallback
                        img.onerror = function() {
                            console.log('‚ö† Erro ao carregar QR Code, tentando fallback...');
                            this.src = `https://quickchart.io/qr?text=${encodeURIComponent(result.qrcode)}&size=300`;
                        };
                        
                        qrContainer.appendChild(img);
                    } else {
                        qrContainer.innerHTML = '<p style="color: red;">Erro ao gerar QR Code</p>';
                    }

                    Swal.close();
                    goToStep(3);
                } else {
                    throw new Error(result.error || result.message || 'Erro ao gerar PIX');
                }
            } catch (error) {
                console.error('Erro ao gerar PIX:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Erro ao gerar PIX',
                    html: `
                        <p>${error.message || 'Ocorreu um erro ao gerar o pagamento.'}</p>
                        <p style="font-size: 12px; color: #666; margin-top: 10px;">
                            Por favor, verifique seus dados e tente novamente.<br>
                            Se o problema persistir, entre em contato com o suporte.
                        </p>
                    `,
                    confirmButtonText: 'OK'
                });
            }
        }

        function copyPixCode() {
            const pixCode = document.getElementById('pixCode').value;
            navigator.clipboard.writeText(pixCode).then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'Copiado!',
                    text: 'C√≥digo PIX copiado para a √°rea de transfer√™ncia',
                    timer: 2000,
                    showConfirmButton: false
                });
            }).catch(() => {
                Swal.fire('Erro', 'N√£o foi poss√≠vel copiar o c√≥digo', 'error');
            });
        }

        function finalizePurchase() {
            Swal.fire({
                title: 'Confirmar Pedido',
                text: 'Voc√™ realizou o pagamento via PIX?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Sim, paguei!',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    let total = product.basePrice;
                    state.selectedAdditionals.forEach((qty, id) => {
                        const item = additionals.find(a => a.id === id);
                        if (item) total += item.price * qty;
                    });
                    state.selectedDrinks.forEach((qty, id) => {
                        const item = drinks.find(d => d.id === id);
                        if (item) total += item.price * qty;
                    });

                    document.getElementById('successMessage').innerHTML = `
                        <strong>Endere√ßo de entrega:</strong><br>
                        ${state.customerAddress}, ${state.customerNumber} - ${state.customerNeighborhood}<br>
                        ${state.customerZipCode}<br><br>
                        <strong>Valor total:</strong> R$ ${total.toFixed(2)}<br>
                        <strong>Telefone:</strong> ${state.customerPhone}
                    `;

                    goToStep('success');
                    document.getElementById('step-success').classList.add('active');
                }
            });
        }

        function setupStepNavigation() {
            document.querySelectorAll('header .step').forEach(el => {
                el.addEventListener('click', function() {
                    const step = parseInt(this.dataset.step);
                    if (step < state.currentStep) {
                        goToStep(step);
                    }
                });
            });
        }
    </script>
</body>
</html>
